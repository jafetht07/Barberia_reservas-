<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Barber√≠a - Sistema de Reservas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <!-- HEADER -->
    <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-2xl p-6 mb-6 shadow-2xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
          </svg>
          <div>
            <h1 class="text-3xl font-bold text-white">Mi Barber√≠a</h1>
            <p class="text-amber-100">Sistema de Reservas</p>
          </div>
        </div>
        <button id="btnAdmin"
          class="bg-white text-amber-600 px-4 py-2 rounded-lg font-semibold hover:bg-amber-50 transition-all flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          Admin
        </button>
      </div>
    </div>

    <!-- MENSAJE -->
    <div id="mensaje" class="hidden mb-4 p-4 rounded-lg text-white"></div>

    <!-- LOGIN ADMIN -->
    <div id="loginAdmin" class="hidden bg-slate-800 rounded-xl p-6 mb-6 shadow-xl">
      <h3 class="text-xl font-bold text-white mb-4">Acceso Administrador</h3>
      <div class="flex gap-2">
        <input type="password" id="passwordInput" placeholder="Contrase√±a"
          class="flex-1 px-4 py-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:border-amber-500">
        <button id="btnLogin"
          class="bg-amber-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-amber-600 transition-all">Entrar</button>
      </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="vistaAdmin" class="hidden bg-slate-800 rounded-xl p-6 shadow-xl">
      
      <!-- PANEL DE DIAGN√ìSTICO (SOLO VISIBLE PARA ADMIN) -->
      <div class="bg-gradient-to-r from-blue-900 to-blue-800 text-white rounded-xl p-4 mb-6 shadow-lg border border-blue-700">
        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Panel de Diagn√≥stico
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div class="bg-blue-800 rounded-lg p-3">
            <div class="text-xs text-blue-300 mb-1">Estado Firebase</div>
            <div class="font-bold text-base" id="firebaseStatus">üîÑ Conectando...</div>
          </div>
          <div class="bg-blue-800 rounded-lg p-3">
            <div class="text-xs text-blue-300 mb-1">Reservas Cargadas</div>
            <div class="font-bold text-base">üìä <span id="totalReservas">0</span></div>
          </div>
          <div class="bg-blue-800 rounded-lg p-3">
            <div class="text-xs text-blue-300 mb-1">√öltima Actualizaci√≥n</div>
            <div class="font-bold text-sm" id="ultimaActualizacion">-</div>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button onclick="window.recargarReservas()" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-500 transition-all font-semibold flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Recargar Reservas
          </button>
          <button onclick="window.testConexion()" class="bg-purple-600 px-4 py-2 rounded-lg hover:bg-purple-500 transition-all font-semibold flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            Test Conexi√≥n
          </button>
          <button onclick="window.verConsola()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-500 transition-all font-semibold flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Ver Diagn√≥stico
          </button>
          <button onclick="window.archivarPasadas()" class="bg-orange-600 px-4 py-2 rounded-lg hover:bg-orange-500 transition-all font-semibold flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
            </svg>
            Archivar Pasadas
          </button>
        </div>
      </div>

      <!-- ESTAD√çSTICAS -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl p-4 text-white">
          <div class="text-sm opacity-90 mb-1">Citas Hoy</div>
          <div class="text-3xl font-bold" id="citasHoy">0</div>
        </div>
        <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl p-4 text-white">
          <div class="text-sm opacity-90 mb-1">Citas Esta Semana</div>
          <div class="text-3xl font-bold" id="citasSemana">0</div>
        </div>
        <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-xl p-4 text-white">
          <div class="text-sm opacity-90 mb-1">Total Activas</div>
          <div class="text-3xl font-bold" id="citasActivas">0</div>
        </div>
      </div>

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
          <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          Todas las Reservas
          <span id="contadorAdmin" class="text-sm bg-amber-500 px-2 py-1 rounded">0</span>
        </h2>
        <button id="btnSalirAdmin" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600">
          Salir
        </button>
      </div>
      <div id="listaReservasAdmin" class="space-y-4"></div>
    </div>

    <!-- VISTA CLIENTE -->
    <div id="vistaCliente" class="bg-slate-800 rounded-xl p-6 shadow-xl">
      <h2 class="text-2xl font-bold text-white mb-6">Reserva tu Cita</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-amber-400 font-semibold mb-2">Tu Nombre</label>
          <input type="text" id="nombreCliente" placeholder="Ingresa tu nombre"
            class="w-full px-4 py-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:border-amber-500">
        </div>

        <div>
          <label class="block text-amber-400 font-semibold mb-2">Fecha</label>
          <input type="date" id="fechaSeleccionada"
            class="w-full px-4 py-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:border-amber-500">
        </div>

        <div id="horariosContainer" class="hidden">
          <label class="block text-amber-400 font-semibold mb-2">Horarios Disponibles</label>
          <div id="horariosGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
        </div>

        <button id="btnReservar"
          class="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-white py-4 rounded-lg font-bold text-lg hover:from-amber-600 hover:to-amber-700 transition-all shadow-lg">
          Confirmar Reserva
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      deleteDoc, 
      doc, 
      getDocs,
      onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDk3yWLE7hWOw9PfFmxtMF4mc66Fn0f7RE",
      authDomain: "barberia-reservas-ed483.firebaseapp.com",
      projectId: "barberia-reservas-ed483",
      storageBucket: "barberia-reservas-ed483.firebasestorage.app",
      messagingSenderId: "46695495621",
      appId: "1:46695495621:web:e03639030544a9d9903dac",
      measurementId: "G-F9BP406HEG"
    };

    // Variables globales
    let app, db;
    let reservas = [];
    let vistaAdminActiva = false;
    let horaSeleccionada = "";
    const ADMIN_PASSWORD = "tuko123";
    const HORARIOS = [
      "08:00","08:30","09:00","09:30","10:00","10:30",
      "11:00","11:30","12:00","12:30","13:00","13:30",
      "14:00","14:30","15:00","15:30","16:00","16:30",
      "17:00","17:30","18:00","18:30","19:00","19:30"
    ];

    // Inicializar Firebase
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log('‚úÖ Firebase inicializado');
      
      // Cargar reservas inmediatamente
      cargarReservas();
      
      // Listener en tiempo real
      onSnapshot(collection(db, "reservas"), (snapshot) => {
        console.log('üîî Cambio detectado en Firebase');
        cargarReservas();
      });
      
    } catch (error) {
      console.error('‚ùå Error Firebase:', error);
      alert('Error al conectar con Firebase. Revisa la consola.');
    }

    // üì• FUNCI√ìN PRINCIPAL: CARGAR RESERVAS
    async function cargarReservas() {
      try {
        console.log('üì• Cargando reservas desde Firebase...');
        
        const reservasRef = collection(db, "reservas");
        const querySnapshot = await getDocs(reservasRef);
        
        reservas = [];
        const ahora = new Date();
        const hoy = ahora.toISOString().split('T')[0];
        const horaActual = ahora.getHours() * 100 + ahora.getMinutes(); // Ej: 14:30 = 1430
        
        if (querySnapshot.empty) {
          console.log('‚ö†Ô∏è No hay documentos en la colecci√≥n');
        } else {
          querySnapshot.forEach((documento) => {
            const data = documento.data();
            const fechaReserva = data.fecha;
            const [h, m] = data.hora.split(':');
            const horaReserva = parseInt(h) * 100 + parseInt(m);
            
            // Solo incluir reservas futuras o del d√≠a actual con hora futura
            if (fechaReserva > hoy || (fechaReserva === hoy && horaReserva > horaActual)) {
              reservas.push({
                id: documento.id,
                fecha: data.fecha,
                hora: data.hora,
                cliente: data.cliente
              });
            } else {
              // Marcar para archivar (opcional, por ahora solo las excluimos)
              console.log(`‚è∞ Reserva pasada: ${data.fecha} ${data.hora} - ${data.cliente}`);
            }
          });
        }
        
        console.log(`‚úÖ ${reservas.length} reservas activas cargadas`);
        
        // Actualizar estad√≠sticas
        actualizarEstadisticas();
        
        // Actualizar UI solo si el admin est√° activo
        if (vistaAdminActiva) {
          document.getElementById('totalReservas').textContent = reservas.length;
          document.getElementById('firebaseStatus').textContent = `‚úÖ Conectado (${reservas.length})`;
          document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString('es-ES');
          mostrarReservasAdmin();
        }
        
        const fechaSeleccionada = document.getElementById('fechaSeleccionada').value;
        if (fechaSeleccionada) {
          mostrarHorarios();
        }
        
      } catch (error) {
        console.error('‚ùå ERROR AL CARGAR RESERVAS:', error);
        
        if (vistaAdminActiva) {
          document.getElementById('firebaseStatus').textContent = '‚ùå Error: ' + error.code;
          document.getElementById('totalReservas').textContent = 'ERROR';
        }
        
        let mensajeError = '';
        if (error.code === 'permission-denied') {
          mensajeError = 'üîí ERROR DE PERMISOS\n\nNo tienes permiso para leer la base de datos.\n\nSOLUCI√ìN:\n1. Ve a Firebase Console\n2. Cloud Firestore ‚Üí Reglas\n3. Cambia a: allow read, write: if true;\n4. Publica los cambios';
        } else {
          mensajeError = 'Error: ' + error.message;
        }
        
        alert(mensajeError);
      }
    }

    // üìä ACTUALIZAR ESTAD√çSTICAS
    function actualizarEstadisticas() {
      const ahora = new Date();
      const hoy = ahora.toISOString().split('T')[0];
      
      // Citas de hoy
      const citasHoy = reservas.filter(r => r.fecha === hoy).length;
      
      // Citas de esta semana (de hoy hasta dentro de 7 d√≠as)
      const dentroDeUnaSemana = new Date(ahora);
      dentroDeUnaSemana.setDate(ahora.getDate() + 7);
      const fechaLimite = dentroDeUnaSemana.toISOString().split('T')[0];
      
      const citasSemana = reservas.filter(r => r.fecha >= hoy && r.fecha <= fechaLimite).length;
      
      // Total activas
      const citasActivas = reservas.length;
      
      if (vistaAdminActiva) {
        document.getElementById('citasHoy').textContent = citasHoy;
        document.getElementById('citasSemana').textContent = citasSemana;
        document.getElementById('citasActivas').textContent = citasActivas;
      }
    }

    // üóëÔ∏è ARCHIVAR CITAS PASADAS
    window.archivarPasadas = async function() {
      if (!confirm('¬øArchivar todas las citas pasadas?\n\nEsto eliminar√° permanentemente las reservas de fechas y horas anteriores.')) return;
      
      try {
        const reservasRef = collection(db, "reservas");
        const querySnapshot = await getDocs(reservasRef);
        
        const ahora = new Date();
        const hoy = ahora.toISOString().split('T')[0];
        const horaActual = ahora.getHours() * 100 + ahora.getMinutes();
        
        let eliminadas = 0;
        const promesas = [];
        
        querySnapshot.forEach((documento) => {
          const data = documento.data();
          const fechaReserva = data.fecha;
          const [h, m] = data.hora.split(':');
          const horaReserva = parseInt(h) * 100 + parseInt(m);
          
          // Eliminar si es fecha pasada o hora pasada del d√≠a actual
          if (fechaReserva < hoy || (fechaReserva === hoy && horaReserva <= horaActual)) {
            promesas.push(deleteDoc(doc(db, "reservas", documento.id)));
            eliminadas++;
            console.log(`üóëÔ∏è Archivando: ${data.fecha} ${data.hora} - ${data.cliente}`);
          }
        });
        
        await Promise.all(promesas);
        
        mostrarMensaje(`‚úÖ ${eliminadas} citas pasadas archivadas`, 'success');
        await cargarReservas();
        
      } catch (error) {
        console.error('‚ùå Error al archivar:', error);
        mostrarMensaje('‚ùå Error al archivar: ' + error.message, 'error');
      }
    };

    // Exponer funci√≥n globalmente
    window.recargarReservas = cargarReservas;
    
    // üìã FUNCI√ìN DE DIAGN√ìSTICO
    window.verConsola = function() {
      const diagnostico = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîç DIAGN√ìSTICO DEL SISTEMA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üì± ESTADO DE FIREBASE:
  ‚Ä¢ App inicializada: ${app ? '‚úÖ S√≠' : '‚ùå No'}
  ‚Ä¢ Base de datos: ${db ? '‚úÖ Conectada' : '‚ùå Desconectada'}
  ‚Ä¢ Proyecto: ${firebaseConfig.projectId}

üìä DATOS EN MEMORIA:
  ‚Ä¢ Reservas cargadas: ${reservas.length}
  ‚Ä¢ Vista admin activa: ${vistaAdminActiva ? 'S√≠' : 'No'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${reservas.length > 0 ? 'üìã RESERVAS ACTUALES:\n' + reservas.map((r, i) => `${i+1}. ${r.fecha} ${r.hora} - ${r.cliente}`).join('\n') : '‚ö†Ô∏è NO HAY RESERVAS CARGADAS'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      `;
      
      console.log(diagnostico);
      alert('üìã Diagn√≥stico generado\n\nRevisa la CONSOLA (presiona F12) para ver los detalles completos.');
    };
    
    // üß™ FUNCI√ìN DE TEST
    window.testConexion = async function() {
      console.log('üß™ ========== TEST DE CONEXI√ìN ==========');
      alert('Iniciando test de conexi√≥n...\nRevisa la consola (F12) para ver los resultados');
      
      try {
        console.log('1Ô∏è‚É£ Verificando Firebase...');
        console.log('   App:', app);
        console.log('   DB:', db);
        
        console.log('2Ô∏è‚É£ Intentando leer colecci√≥n "reservas"...');
        const testRef = collection(db, "reservas");
        
        console.log('3Ô∏è‚É£ Ejecutando getDocs...');
        const snapshot = await getDocs(testRef);
        console.log('   N√∫mero de documentos:', snapshot.size);
        
        if (snapshot.empty) {
          alert('‚ö†Ô∏è TEST RESULTADO:\n\nLa colecci√≥n existe pero est√° VAC√çA.\nNo hay reservas guardadas.');
        } else {
          const docs = [];
          snapshot.forEach((doc) => {
            docs.push({ id: doc.id, ...doc.data() });
          });
          console.table(docs);
          alert(`‚úÖ TEST EXITOSO!\n\nSe encontraron ${snapshot.size} reservas.\n\nRevisa la consola para ver los detalles.`);
          
          reservas = docs;
          document.getElementById('totalReservas').textContent = reservas.length;
          if (vistaAdminActiva) {
            mostrarReservasAdmin();
          }
        }
        
        console.log('‚úÖ Test completado');
        
      } catch (error) {
        console.error('‚ùå ERROR EN TEST:', error);
        alert(`‚ùå ERROR:\n\nC√≥digo: ${error.code}\nMensaje: ${error.message}\n\nVerifica las reglas de Firebase.`);
      }
    };

    // üé® MOSTRAR RESERVAS EN ADMIN
    function mostrarReservasAdmin() {
      const cont = document.getElementById('listaReservasAdmin');
      const contador = document.getElementById('contadorAdmin');
      
      contador.textContent = reservas.length;
      
      if (reservas.length === 0) {
        cont.innerHTML = `
          <div class='text-center py-12 border-2 border-dashed border-slate-600 rounded-lg'>
            <svg class="w-16 h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class='text-slate-400 text-lg font-semibold'>No hay reservas registradas</p>
            <p class='text-slate-500 text-sm mt-2'>Las reservas aparecer√°n aqu√≠ autom√°ticamente</p>
            <button onclick="window.recargarReservas()" class="mt-4 bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600">
              üîÑ Recargar Datos
            </button>
          </div>
        `;
        return;
      }

      const porFecha = {};
      reservas.forEach(r => {
        if (!porFecha[r.fecha]) porFecha[r.fecha] = [];
        porFecha[r.fecha].push(r);
      });

      Object.keys(porFecha).forEach(fecha => {
        porFecha[fecha].sort((a, b) => a.hora.localeCompare(b.hora));
      });

      const fechasOrdenadas = Object.keys(porFecha).sort();
      
      cont.innerHTML = fechasOrdenadas.map(f => `
        <div class='bg-slate-700 rounded-lg p-4 border-l-4 border-amber-500'>
          <h3 class='text-xl font-bold text-amber-400 mb-3'>
            üìÖ ${formatearFecha(f)} (${porFecha[f].length})
          </h3>
          <div class="space-y-2">
            ${porFecha[f].map(r => `
              <div class='bg-slate-600 rounded-lg p-3 flex justify-between items-center hover:bg-slate-500 transition-all'>
                <div class="flex items-center gap-3">
                  <span class='text-amber-300 font-bold text-lg'>üïê ${r.hora}</span>
                  <span class='text-white font-semibold'>üë§ ${r.cliente}</span>
                </div>
                <button onclick="window.eliminarReserva('${r.id}')" 
                  class='bg-red-500 px-4 py-2 rounded-lg text-white hover:bg-red-600 font-semibold'>
                  üóëÔ∏è Eliminar
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // üïê MOSTRAR HORARIOS
    function mostrarHorarios() {
      const fecha = document.getElementById('fechaSeleccionada').value;
      if (!fecha) return;

      const cont = document.getElementById('horariosContainer');
      const grid = document.getElementById('horariosGrid');
      cont.classList.remove('hidden');
      horaSeleccionada = "";

      const horariosOcupados = reservas.filter(r => r.fecha === fecha).map(r => r.hora);
      
      // Verificar si es hoy para ocultar horas pasadas
      const ahora = new Date();
      const hoy = ahora.toISOString().split('T')[0];
      const horaActualNum = ahora.getHours() * 100 + ahora.getMinutes(); // Ej: 14:30 = 1430
      const esHoy = fecha === hoy;

      grid.innerHTML = HORARIOS.map(h => {
        const ocupado = horariosOcupados.includes(h);
        const [hora, minuto] = h.split(':');
        const horaNum = parseInt(hora) * 100 + parseInt(minuto);
        const horaPasada = esHoy && horaNum <= horaActualNum;
        
        // Si es hora pasada o est√° ocupada, deshabilitar
        const deshabilitado = ocupado || horaPasada;
        
        let claseBoton, textoBoton;
        if (horaPasada) {
          claseBoton = 'py-3 rounded-lg font-semibold bg-gray-800 text-gray-500 cursor-not-allowed opacity-40';
          textoBoton = '‚è∞ ' + h;
        } else if (ocupado) {
          claseBoton = 'py-3 rounded-lg font-semibold bg-red-900 text-red-300 cursor-not-allowed opacity-50';
          textoBoton = '‚ùå ' + h;
        } else {
          claseBoton = 'py-3 rounded-lg font-semibold bg-slate-700 text-white hover:bg-amber-500 hover:scale-105 transition-all';
          textoBoton = h;
        }
        
        return `
          <button 
            id='hora-${h.replace(':','-')}' 
            onclick='${deshabilitado ? '' : `window.seleccionarHora("${h}")`}' 
            ${deshabilitado ? 'disabled' : ''} 
            class='${claseBoton}'>
            ${textoBoton}
          </button>
        `;
      }).join('');
    }

    // ‚úÖ SELECCIONAR HORA
    window.seleccionarHora = function(h) {
      horaSeleccionada = h;
      HORARIOS.forEach(hh => {
        const btn = document.getElementById(`hora-${hh.replace(':','-')}`);
        if (!btn || btn.disabled) return;
        btn.className = hh === h 
          ? 'py-3 rounded-lg font-semibold bg-amber-500 text-white scale-110 shadow-lg'
          : 'py-3 rounded-lg font-semibold bg-slate-700 text-white hover:bg-amber-500 hover:scale-105 transition-all';
      });
    };

    // üíæ HACER RESERVA
    async function hacerReserva() {
      const nombre = document.getElementById('nombreCliente').value.trim();
      const fecha = document.getElementById('fechaSeleccionada').value;

      if (!nombre || !fecha || !horaSeleccionada) {
        mostrarMensaje('‚ùå Completa todos los campos', 'error');
        return;
      }

      try {
        await addDoc(collection(db, "reservas"), {
          fecha, hora: horaSeleccionada, cliente: nombre, timestamp: Date.now()
        });
        
        mostrarMensaje(`‚úÖ Reserva confirmada: ${nombre} - ${formatearFecha(fecha)} ${horaSeleccionada}`, 'success');
        
        document.getElementById('nombreCliente').value = '';
        document.getElementById('fechaSeleccionada').value = '';
        document.getElementById('horariosContainer').classList.add('hidden');
        horaSeleccionada = "";
        
        setTimeout(() => cargarReservas(), 500);
      } catch (error) {
        mostrarMensaje('‚ùå Error: ' + error.message, 'error');
      }
    }

    // üóëÔ∏è ELIMINAR
    window.eliminarReserva = async function(id) {
      if (!confirm('¬øEliminar esta reserva?')) return;
      try {
        await deleteDoc(doc(db, "reservas", id));
        mostrarMensaje('‚úÖ Reserva eliminada', 'success');
        await cargarReservas();
      } catch (error) {
        mostrarMensaje('‚ùå Error: ' + error.message, 'error');
      }
    };

    // UI
    function toggleAdmin() {
      document.getElementById('loginAdmin').classList.toggle('hidden');
    }

    function salirAdmin() {
      vistaAdminActiva = false;
      document.getElementById('vistaAdmin').classList.add('hidden');
      document.getElementById('vistaCliente').classList.remove('hidden');
    }

    function iniciarSesionAdmin() {
      const pass = document.getElementById('passwordInput').value;
      if (pass === ADMIN_PASSWORD) {
        vistaAdminActiva = true;
        document.getElementById('loginAdmin').classList.add('hidden');
        document.getElementById('vistaCliente').classList.add('hidden');
        document.getElementById('vistaAdmin').classList.remove('hidden');
        document.getElementById('passwordInput').value = '';
        
        // Actualizar el panel de diagn√≥stico
        document.getElementById('firebaseStatus').textContent = `‚úÖ Conectado (${reservas.length})`;
        document.getElementById('totalReservas').textContent = reservas.length;
        document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString('es-ES');
        
        cargarReservas().then(() => mostrarReservasAdmin());
        mostrarMensaje('‚úÖ Sesi√≥n iniciada', 'success');
        
        // Programar limpieza autom√°tica a medianoche
        programarLimpiezaMedianoche();
      } else {
        mostrarMensaje('‚ùå Contrase√±a incorrecta', 'error');
      }
    }

    // üïê PROGRAMAR LIMPIEZA AUTOM√ÅTICA A MEDIANOCHE
    function programarLimpiezaMedianoche() {
      const ahora = new Date();
      const manana = new Date(ahora);
      manana.setDate(manana.getDate() + 1);
      manana.setHours(0, 0, 0, 0); // Medianoche
      
      const msHastaMedianoche = manana.getTime() - ahora.getTime();
      
      console.log(`‚è∞ Limpieza autom√°tica programada para: ${manana.toLocaleString('es-ES')}`);
      console.log(`   (en ${Math.round(msHastaMedianoche / 1000 / 60)} minutos)`);
      
      setTimeout(async () => {
        console.log('üïõ ¬°Es medianoche! Archivando citas pasadas autom√°ticamente...');
        await window.archivarPasadas();
        // Reprogramar para la pr√≥xima medianoche
        programarLimpiezaMedianoche();
      }, msHastaMedianoche);
    }

    function mostrarMensaje(txt, tipo) {
      const msg = document.getElementById('mensaje');
      msg.textContent = txt;
      msg.className = `mb-4 p-4 rounded-lg text-white font-semibold ${tipo === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 4000);
    }

    function formatearFecha(f) {
      const [year, month, day] = f.split('-');
      const fecha = new Date(year, month - 1, day);
      return fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Event Listeners
    document.getElementById('btnAdmin').addEventListener('click', toggleAdmin);
    document.getElementById('btnLogin').addEventListener('click', iniciarSesionAdmin);
    document.getElementById('btnSalirAdmin').addEventListener('click', salirAdmin);
    document.getElementById('fechaSeleccionada').addEventListener('change', mostrarHorarios);
    document.getElementById('btnReservar').addEventListener('click', hacerReserva);
    document.getElementById('passwordInput').addEventListener('keypress', e => { 
      if (e.key === 'Enter') iniciarSesionAdmin(); 
    });
    
    const hoy = new Date();
    document.getElementById('fechaSeleccionada').min = hoy.toISOString().split('T')[0];
  </script>
</body>
</html>
