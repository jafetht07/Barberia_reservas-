<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi BarberÃ­a - Sistema de Reservas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <!-- HEADER -->
    <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-2xl p-6 mb-6 shadow-2xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
          </svg>
          <div>
            <h1 class="text-3xl font-bold text-white">Mi BarberÃ­a</h1>
            <p class="text-amber-100">Sistema de Reservas</p>
          </div>
        </div>
        <button id="btnAdmin"
          class="bg-white text-amber-600 px-4 py-2 rounded-lg font-semibold hover:bg-amber-50 transition-all flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          Admin
        </button>
      </div>
    </div>

    <!-- PANEL DE DIAGNÃ“STICO -->
    <div class="bg-gradient-to-r from-blue-900 to-blue-800 text-white rounded-xl p-5 mb-6 shadow-lg border-2 border-blue-600">
      <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Panel de DiagnÃ³stico
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <div class="bg-blue-800 rounded-lg p-3 border border-blue-600">
          <div class="text-xs text-blue-300 mb-1">ğŸ”Œ Estado Firebase</div>
          <div class="font-bold text-base" id="firebaseStatus">ğŸ”„ Conectando...</div>
        </div>
        <div class="bg-blue-800 rounded-lg p-3 border border-blue-600">
          <div class="text-xs text-blue-300 mb-1">ğŸ“Š Reservas Cargadas</div>
          <div class="font-bold text-base"><span id="totalReservas">0</span> reservas</div>
        </div>
        <div class="bg-blue-800 rounded-lg p-3 border border-blue-600">
          <div class="text-xs text-blue-300 mb-1">â° Ãšltima ActualizaciÃ³n</div>
          <div class="font-bold text-sm" id="ultimaActualizacion">Nunca</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="btnRecargar" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-500 transition-all font-semibold flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Recargar Datos
        </button>
        
        <button id="btnTestConexion" class="bg-purple-600 px-4 py-2 rounded-lg hover:bg-purple-500 transition-all font-semibold flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
          </svg>
          Test ConexiÃ³n
        </button>
        
        <button id="btnDiagnostico" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-500 transition-all font-semibold flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          Ver DiagnÃ³stico
        </button>
      </div>
    </div>

    <!-- MENSAJE -->
    <div id="mensaje" class="hidden mb-4 p-4 rounded-lg text-white"></div>

    <!-- LOGIN ADMIN -->
    <div id="loginAdmin" class="hidden bg-slate-800 rounded-xl p-6 mb-6 shadow-xl">
      <h3 class="text-xl font-bold text-white mb-4">Acceso Administrador</h3>
      <div class="flex gap-2">
        <input type="password" id="passwordInput" placeholder="ContraseÃ±a"
          class="flex-1 px-4 py-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:border-amber-500">
        <button id="btnLogin"
          class="bg-amber-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-amber-600 transition-all">Entrar</button>
      </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="vistaAdmin" class="hidden bg-slate-800 rounded-xl p-6 shadow-xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
          <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          Todas las Reservas
          <span id="contadorAdmin" class="text-sm bg-amber-500 px-2 py-1 rounded">0</span>
        </h2>
        <button id="btnSalirAdmin" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600">
          Salir
        </button>
      </div>
      <div id="listaReservasAdmin" class="space-y-4"></div>
    </div>

    <!-- VISTA CLIENTE -->
    <div id="vistaCliente" class="bg-slate-800 rounded-xl p-6 shadow-xl">
      <h2 class="text-2xl font-bold text-white mb-6">Reserva tu Cita</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-amber-400 font-semibold mb-2">Tu Nombre</label>
          <input type="text" id="nombreCliente" placeholder="Ingresa tu nombre"
            class="w-full px-4 py-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:border-amber-500">
        </div>

        <div>
          <label class="block text-amber-400 font-semibold mb-2">Fecha</label>
          <input type="date" id="fechaSeleccionada"
            class="w-full px-4 py-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:border-amber-500">
        </div>

        <div id="horariosContainer" class="hidden">
          <label class="block text-amber-400 font-semibold mb-2">Horarios Disponibles</label>
          <div id="horariosGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
        </div>

        <button id="btnReservar"
          class="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-white py-4 rounded-lg font-bold text-lg hover:from-amber-600 hover:to-amber-700 transition-all shadow-lg">
          Confirmar Reserva
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      deleteDoc, 
      doc, 
      getDocs,
      onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDk3yWLE7hWOw9PfFmxtMF4mc66Fn0f7RE",
      authDomain: "barberia-reservas-ed483.firebaseapp.com",
      projectId: "barberia-reservas-ed483",
      storageBucket: "barberia-reservas-ed483.firebasestorage.app",
      messagingSenderId: "46695495621",
      appId: "1:46695495621:web:e03639030544a9d9903dac",
      measurementId: "G-F9BP406HEG"
    };

    // Variables globales
    let app, db;
    let reservas = [];
    let vistaAdminActiva = false;
    let horaSeleccionada = "";
    const ADMIN_PASSWORD = "tuko123";
    const HORARIOS = [
      "08:00","08:30","09:00","09:30","10:00","10:30",
      "11:00","11:30","12:00","12:30","13:00","13:30",
      "14:00","14:30","15:00","15:30","16:00","16:30",
      "17:00","17:30","18:00","18:30","19:00","19:30"
    ];

    // Inicializar Firebase
    try {
      console.log('ğŸš€ Inicializando Firebase...');
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      document.getElementById('firebaseStatus').textContent = 'âœ… Conectado';
      console.log('âœ… Firebase inicializado correctamente');
      
      // Cargar reservas inmediatamente
      cargarReservas();
      
      // Listener en tiempo real
      onSnapshot(collection(db, "reservas"), (snapshot) => {
        console.log('ğŸ”” Cambio detectado en Firebase');
        cargarReservas();
      });
      
    } catch (error) {
      document.getElementById('firebaseStatus').textContent = 'âŒ Error: ' + error.code;
      console.error('âŒ Error al inicializar Firebase:', error);
      alert('âŒ Error al conectar con Firebase:\n\n' + error.message);
    }

    // ğŸ“¥ CARGAR RESERVAS
    async function cargarReservas() {
      try {
        console.log('ğŸ“¥ Cargando reservas...');
        const reservasRef = collection(db, "reservas");
        const querySnapshot = await getDocs(reservasRef);
        
        reservas = [];
        querySnapshot.forEach((documento) => {
          const data = documento.data();
          reservas.push({
            id: documento.id,
            fecha: data.fecha,
            hora: data.hora,
            cliente: data.cliente
          });
        });
        
        console.log(`âœ… ${reservas.length} reservas cargadas`);
        console.table(reservas);
        
        // Actualizar UI
        document.getElementById('totalReservas').textContent = reservas.length;
        document.getElementById('firebaseStatus').textContent = `âœ… Conectado (${reservas.length})`;
        document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString('es-ES');
        
        if (vistaAdminActiva) {
          mostrarReservasAdmin();
        }
        
        const fechaSeleccionada = document.getElementById('fechaSeleccionada').value;
        if (fechaSeleccionada) {
          mostrarHorarios();
        }
        
      } catch (error) {
        console.error('âŒ ERROR AL CARGAR:', error);
        document.getElementById('firebaseStatus').textContent = 'âŒ Error: ' + error.code;
        
        let mensajeError = '';
        if (error.code === 'permission-denied') {
          mensajeError = 'ğŸ”’ ERROR DE PERMISOS\n\nNo tienes permiso para leer la base de datos.\n\nSOLUCIÃ“N:\n1. Ve a Firebase Console\n2. Cloud Firestore â†’ Reglas\n3. Cambia a: allow read, write: if true;\n4. Publica los cambios';
        } else {
          mensajeError = 'Error: ' + error.message;
        }
        alert(mensajeError);
      }
    }

    // ğŸ§ª TEST CONEXIÃ“N
    async function testConexion() {
      console.log('ğŸ§ª ===== TEST DE CONEXIÃ“N =====');
      alert('ğŸ§ª Iniciando test...\n\nRevisa la consola (F12) para ver detalles');
      
      try {
        console.log('1ï¸âƒ£ Firebase App:', app);
        console.log('2ï¸âƒ£ Firestore DB:', db);
        
        const testRef = collection(db, "reservas");
        console.log('3ï¸âƒ£ Referencia:', testRef);
        
        const snapshot = await getDocs(testRef);
        console.log('4ï¸âƒ£ Snapshot:', snapshot);
        console.log('ğŸ“Š Documentos encontrados:', snapshot.size);
        
        if (snapshot.empty) {
          alert('âš ï¸ TEST RESULTADO:\n\nLa colecciÃ³n existe pero estÃ¡ VACÃA.\nNo hay reservas guardadas.');
        } else {
          const docs = [];
          snapshot.forEach((doc) => {
            docs.push({ id: doc.id, ...doc.data() });
          });
          console.table(docs);
          alert(`âœ… TEST EXITOSO!\n\nSe encontraron ${snapshot.size} reservas.\n\nRevisa la consola para ver los detalles.`);
          
          reservas = docs;
          document.getElementById('totalReservas').textContent = reservas.length;
          if (vistaAdminActiva) {
            mostrarReservasAdmin();
          }
        }
        
      } catch (error) {
        console.error('âŒ ERROR EN TEST:', error);
        alert(`âŒ ERROR:\n\nCÃ³digo: ${error.code}\nMensaje: ${error.message}\n\nVerifica las reglas de Firebase.`);
      }
    }

    // ğŸ“‹ DIAGNÃ“STICO
    function verDiagnostico() {
      const info = `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” DIAGNÃ“STICO DEL SISTEMA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“± FIREBASE:
  â€¢ App: ${app ? 'âœ… Inicializada' : 'âŒ No inicializada'}
  â€¢ DB: ${db ? 'âœ… Conectada' : 'âŒ Desconectada'}
  â€¢ Proyecto: ${firebaseConfig.projectId}

ğŸ“Š DATOS:
  â€¢ Reservas en memoria: ${reservas.length}
  â€¢ Vista admin: ${vistaAdminActiva ? 'Activa' : 'Inactiva'}

${reservas.length > 0 ? '\nğŸ“‹ RESERVAS:\n' + reservas.map((r, i) => `  ${i+1}. ${r.fecha} ${r.hora} - ${r.cliente}`).join('\n') : '  âš ï¸ Sin reservas'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      `;
      
      console.log(info);
      alert('ğŸ“‹ DiagnÃ³stico generado!\n\nRevisa la CONSOLA (F12) para ver toda la informaciÃ³n.');
    }

    // ğŸ¨ MOSTRAR RESERVAS ADMIN
    function mostrarReservasAdmin() {
      const cont = document.getElementById('listaReservasAdmin');
      const contador = document.getElementById('contadorAdmin');
      
      contador.textContent = reservas.length;
      
      if (reservas.length === 0) {
        cont.innerHTML = `
          <div class='text-center py-12 border-2 border-dashed border-slate-600 rounded-lg'>
            <p class='text-slate-400 text-lg font-semibold'>No hay reservas registradas</p>
            <button onclick="location.reload()" class="mt-4 bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600">
              ğŸ”„ Recargar
            </button>
          </div>
        `;
        return;
      }

      const porFecha = {};
      reservas.forEach(r => {
        if (!porFecha[r.fecha]) porFecha[r.fecha] = [];
        porFecha[r.fecha].push(r);
      });

      Object.keys(porFecha).forEach(fecha => {
        porFecha[fecha].sort((a, b) => a.hora.localeCompare(b.hora));
      });

      const fechasOrdenadas = Object.keys(porFecha).sort();
      
      cont.innerHTML = fechasOrdenadas.map(f => `
        <div class='bg-slate-700 rounded-lg p-4 border-l-4 border-amber-500'>
          <h3 class='text-xl font-bold text-amber-400 mb-3'>
            ğŸ“… ${formatearFecha(f)} (${porFecha[f].length})
          </h3>
          <div class="space-y-2">
            ${porFecha[f].map(r => `
              <div class='bg-slate-600 rounded-lg p-3 flex justify-between items-center hover:bg-slate-500 transition-all'>
                <div class="flex items-center gap-3">
                  <span class='text-amber-300 font-bold text-lg'>ğŸ• ${r.hora}</span>
                  <span class='text-white font-semibold'>ğŸ‘¤ ${r.cliente}</span>
                </div>
                <button onclick="eliminarReserva('${r.id}')" 
                  class='bg-red-500 px-4 py-2 rounded-lg text-white hover:bg-red-600 font-semibold'>
                  ğŸ—‘ï¸ Eliminar
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // ğŸ• MOSTRAR HORARIOS
    function mostrarHorarios() {
      const fecha = document.getElementById('fechaSeleccionada').value;
      if (!fecha) return;

      const cont = document.getElementById('horariosContainer');
      const grid = document.getElementById('horariosGrid');
      cont.classList.remove('hidden');
      horaSeleccionada = "";

      const horariosOcupados = reservas.filter(r => r.fecha === fecha).map(r => r.hora);

      grid.innerHTML = HORARIOS.map(h => {
        const ocupado = horariosOcupados.includes(h);
        return `
          <button 
            id='hora-${h.replace(':','-')}' 
            onclick='${ocupado ? '' : `seleccionarHora("${h}")`}' 
            ${ocupado ? 'disabled' : ''} 
            class='py-3 rounded-lg font-semibold ${ocupado ? 'bg-red-900 text-red-300 cursor-not-allowed opacity-50' : 'bg-slate-700 text-white hover:bg-amber-500 hover:scale-105 transition-all'}'>
            ${ocupado ? 'âŒ ' : ''}${h}
          </button>
        `;
      }).join('');
    }

    // âœ… SELECCIONAR HORA
    window.seleccionarHora = function(h) {
      horaSeleccionada = h;
      HORARIOS.forEach(hh => {
        const btn = document.getElementById(`hora-${hh.replace(':','-')}`);
        if (!btn || btn.disabled) return;
        btn.className = hh === h 
          ? 'py-3 rounded-lg font-semibold bg-amber-500 text-white scale-110 shadow-lg'
          : 'py-3 rounded-lg font-semibold bg-slate-700 text-white hover:bg-amber-500 hover:scale-105 transition-all';
      });
    };

    // ğŸ’¾ HACER RESERVA
    async function hacerReserva() {
      const nombre = document.getElementById('nombreCliente').value.trim();
      const fecha = document.getElementById('fechaSeleccionada').value;

      if (!nombre || !fecha || !horaSeleccionada) {
        mostrarMensaje('âŒ Completa todos los campos', 'error');
        return;
      }

      try {
        await addDoc(collection(db, "reservas"), {
          fecha, hora: horaSeleccionada, cliente: nombre, timestamp: Date.now()
        });
        
        mostrarMensaje(`âœ… Reserva confirmada: ${nombre} - ${formatearFecha(fecha)} ${horaSeleccionada}`, 'success');
        
        document.getElementById('nombreCliente').value = '';
        document.getElementById('fechaSeleccionada').value = '';
        document.getElementById('horariosContainer').classList.add('hidden');
        horaSeleccionada = "";
        
        setTimeout(() => cargarReservas(), 500);
      } catch (error) {
        mostrarMensaje('âŒ Error: ' + error.message, 'error');
      }
    }

    // ğŸ—‘ï¸ ELIMINAR
    window.eliminarReserva = async function(id) {
      if (!confirm('Â¿Eliminar esta reserva?')) return;
      try {
        await deleteDoc(doc(db, "reservas", id));
        mostrarMensaje('âœ… Reserva eliminada', 'success');
        await cargarReservas();
      } catch (error) {
        mostrarMensaje('âŒ Error: ' + error.message, 'error');
      }
    };

    // UI
    function toggleAdmin() {
      document.getElementById('loginAdmin').classList.toggle('hidden');
    }

    function salirAdmin() {
      vistaAdminActiva = false;
      document.getElementById('vistaAdmin').classList.add('hidden');
      document.getElementById('vistaCliente').classList.remove('hidden');
    }

    function iniciarSesionAdmin() {
      const pass = document.getElementById('passwordInput').value;
      if (pass === ADMIN_PASSWORD) {
        vistaAdminActiva = true;
        document.getElementById('loginAdmin').classList.add('hidden');
        document.getElementById('vistaCliente').classList.add('hidden');
        document.getElementById('vistaAdmin').classList.remove('hidden');
        document.getElementById('passwordInput').value = '';
        cargarReservas().then(() => mostrarReservasAdmin());
        mostrarMensaje('âœ… SesiÃ³n iniciada', 'success');
      } else {
        mostrarMensaje('âŒ ContraseÃ±a incorrecta', 'error');
      }
    }

    function mostrarMensaje(txt, tipo) {
      const msg = document.getElementById('mensaje');
      msg.textContent = txt;
      msg.className = `mb-4 p-4 rounded-lg text-white font-semibold ${tipo === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 4000);
    }

    function formatearFecha(f) {
      const [year, month, day] = f.split('-');
      const fecha = new Date(year, month - 1, day);
      return fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Event Listeners
    document.getElementById('btnAdmin').addEventListener('click', toggleAdmin);
    document.getElementById('btnLogin').addEventListener('click', iniciarSesionAdmin);
    document.getElementById('btnSalirAdmin').addEventListener('click', salirAdmin);
    document.getElementById('fechaSeleccionada').addEventListener('change', mostrarHorarios);
    document.getElementById('btnReservar').addEventListener('click', hacerReserva);
    document.getElementById('passwordInput').addEventListener('keypress', e => { 
      if (e.key === 'Enter') iniciarSesionAdmin(); 
    });
    
    // Botones de diagnÃ³stico
    document.getElementById('btnRecargar').addEventListener('click', cargarReservas);
    document.getElementById('btnTestConexion').addEventListener('click', testConexion);
    document.getElementById('btnDiagnostico').addEventListener('click', verDiagnostico);
    
    const hoy = new Date();
    document.getElementById('fechaSeleccionada').min = hoy.toISOString().split('T')[0];
  </script>
</body>
</html>
